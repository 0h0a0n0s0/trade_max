好的，非常樂意為您詳細解說。恭喜您成功啟動了這個複雜的系統，現在了解其內在的運作原理，是駕馭它的關鍵下一步。

我將從策略核心到資金管理，逐一為您拆解說明。

---

### 一、核心交易策略詳解

您的機器人主要由兩套策略疊加而成：**「三層固定間隙網格」** 作為基礎獲利引擎，以及 **「EMA 趨勢偏好」** 作為方向性調節器。

#### 1. 網格是如何建立的？(低買高賣的核心)

網格策略的本質，是在一個基準價格的上下方，像漁網一樣鋪設一系列的買單和賣單，以捕捉價格的來回波動。

[cite_start]整個過程由 `strategy_usdttwd_grid.py` 中的 `rebuild_grid_at_center` 函數負責 [cite: 4]。

**建立步驟如下：**

1.  **確定中心價 (Center Price)**：
    * [cite_start]程式啟動時，會獲取當前的市場最新成交價作為初始的「中心價」 [cite: 4]。
    * [cite_start]在運行過程中，根據您在 `config_usdttwd.yaml` 中設定的 `recenter_interval_minutes`（例如 480 分鐘，即 8 小時），程式會定時重新獲取市場價，並以此為新的中心價，重建整個網格 [cite: 6, 4]。

2.  **計算三層網格的參數**：
    * [cite_start]程式會讀取 `config_usdttwd.yaml` 中的設定 [cite: 6]。假設您的設定如下：
        * `small_gap: "0.035"`
        * `mid_mult: 3`
        * `big_mult: 7`
    * 它會計算出三層網格的絕對價差：
        * **小網格 (Small Grid)**：價差 = `0.035` TWD
        * **中網格 (Mid Grid)**：價差 = `0.035 * 3` = `0.105` TWD
        * **大網格 (Big Grid)**：價差 = `0.035 * 7` = `0.245` TWD

3.  **鋪設買賣訂單**：
    * [cite_start]程式會以「中心價」為基準，根據 `levels_each: 6` 的設定 [cite: 6][cite_start]，在每一層網格的上下方各鋪設 6 層訂單 [cite: 4]。
    * **買單 (Buy Orders)**：價格 = `中心價 - (價差 * n)`，其中 n 從 1 到 6。
    * **賣單 (Sell Orders)**：價格 = `中心價 + (價差 * n)`，其中 n 從 1 到 6。
    * 例如，對於小網格，它會鋪設 `中心價 - 0.035`, `中心價 - 0.070`... 等買單，以及 `中心價 + 0.035`, `中心價 + 0.070`... 等賣單。三層網格會同時鋪設。

4.  **計算訂單大小 (數量)**：
    * [cite_start]這是動態的關鍵。程式會先透過 `update_balances_from_api` 函數計算出您當前的「總權益 (Total Equity)」[cite: 4]，即 `TWD 餘額 + (USDT 餘額 * 當前市價)`。
    * [cite_start]然後根據 `config_usdttwd.yaml` 中的百分比設定來計算每筆訂單要下多少 USDT [cite: 6, 4]。
        * `size_pct_small: "0.015"` -> 小網格每筆訂單的 USDT 數量約為 `(總權益 * 1.5%) / 當前市價`。
        * `size_pct_mid: "0.025"` -> 中網格每筆訂單的 USDT 數量約為 `(總權益 * 2.5%) / 當前市價`。
        * `size_pct_big: "0.035"` -> 大網格每筆訂單的 USDT 數量約為 `(總權益 * 3.5%) / 當前市價`。

[cite_start]**循環獲利**：當一個買單成交後，程式會在**該成交價上方一個對應價差**的位置，掛出一個新的賣單。反之，當一個賣單成交後，會在下方掛出一個新的買單。如此循環，不斷地賺取差價 [cite: 4]。

#### 2. EMA 趨勢策略是如何運作的？

網格策略在盤整行情中表現優異，但在單邊趨勢（大漲或大跌）中會產生浮虧。EMA 策略的目的，就是試圖判斷當前的市場趨勢，並**提前調整您的 USDT 持倉比例**，以減輕單邊行情的風險。

[cite_start]這個邏輯由 `strategy_usdttwd_grid.py` 中的 `manage_directional_bias` 函數負責 [cite: 4]。

**運作方式如下：**

1.  **計算 EMA 指標**：
    * [cite_start]程式會持續追蹤最近的價格數據（儲存在 `PRICE_HISTORY` 變數中）[cite: 4]。
    * [cite_start]根據 `config_usdttwd.yaml` 的設定，計算兩條指數移動平均線 [cite: 6]：
        * `ema_span_fast_bars: 600` -> 一條基於過去 10 小時價格的快線 EMA。
        * `ema_span_slow_bars: 3000` -> 一條基於過去 50 小時價格的慢線 EMA。

2.  **判斷趨勢**：
    * **看漲趨勢 (Golden Cross)**：如果「快線 EMA」上穿並高於「慢線 EMA」，代表短期漲勢強勁，市場可能處於上升趨勢。
    * **看跌趨勢 (Dead Cross)**：如果「快線 EMA」下穿並低於「慢線 EMA」，代表短期跌勢明顯，市場可能處於下降趨勢。

3.  **調整倉位曝險 (Rebalance)**：
    * [cite_start]程式會根據趨勢，設定一個「目標 USDT 曝險比例」（USDT 市值佔總權益的比例）[cite: 4]。
        * [cite_start]看漲時，目標比例為 `bias_high: "0.60"`，即希望您持有較多 USDT（約 60% 的資產是 USDT）[cite: 6]。
        * [cite_start]看跌時，目標比例為 `bias_low: "0.25"`，即希望您減持 USDT，保留更多 TWD（約 25% 的資產是 USDT）[cite: 6]。
    * 程式會計算您**當前實際的曝險比例**與**目標比例**的差距。
    * [cite_start]如果差距的絕對市值超過了 `bias_rebalance_threshold_twd: "300.0"` TWD [cite: 6][cite_start]，程式就會**主動下一個市價單（用限價單模擬）**，去買入或賣出一定數量的 USDT，讓您的持倉比例更接近健康的目標，從而順應趨勢 [cite: 4]。

---

### 二、資金管理與程式維護

#### 1. 我想放大本金，可以直接入金嗎？

**可以，但有兩種不同的效果。**

* **直接入金，不重啟程式**：
    * [cite_start]您的程式會在大約 `api_balance_poll_interval_sec`（預設 300 秒，即 5 分鐘）的間隔內，透過 `update_balances_from_api` 自動偵測到您總權益的增加 [cite: 4]。
    * **影響**：只有在**未來新建立的訂單**（例如某筆舊訂單成交後，要掛出的新訂單）會使用新的、較大的總權益來計算訂單數量。而那些**已經掛在市場上的舊訂單，其數量不會改變**。
    * **優點**：操作無感，不中斷交易。
    * **缺點**：倉位放大的效果是逐步的、緩慢的。

* **先入金，然後結束程式再重啟（推薦）**：
    * **這是最建議的方式。**
    * 當您重啟程式時，它會立刻查詢到您最新的、已增加的總餘額。
    * [cite_start]接著，`handle_orphan_orders_on_startup` 會先將舊的所有掛單全部撤銷 [cite: 4]。
    * [cite_start]然後，`rebuild_grid_at_center` 會使用您**全新的、較大的總權益**，重新計算並建立一整套**所有訂單都已放大**的新網格 [cite: 4]。
    * **優點**：能立刻、完整地讓您的所有交易倉位都匹配您新的本金規模。
    * **缺點**：需要短暫中斷交易（約幾十秒）。

#### 2. 若是我要出金 TWD，直接出金是否有影響？

**有影響，請謹慎操作。**

1.  **總權益降低**：出金 TWD 後，程式在下一次更新餘額時會偵測到總權益下降。這會導致未來新掛出的訂單數量**自動變小**。
2.  [cite_start]**觸發風險控制**：`risk_controller.py` 中有一個關鍵參數 `min_twd_balance_threshold`（例如設定為 3000 TWD）[cite: 6, 5][cite_start]。如果您出金後，剩餘的 TWD 低於這個門檻，風險控制器會**禁止程式下任何新的買單**，以防止您耗盡所有 TWD 而無法購買 USDT。此時程式只會執行賣單 [cite: 5, 4]。
3.  **建議操作**：如果您需要出金，同樣建議**先結束程式，出金完畢後，再重啟程式**。這樣能確保程式基於您最新的資金狀況來建立一個合理的、較小的網格。

#### 3. 交易中途關閉重啟，或有出入金行為，DB 或掛單會有異常嗎？

**完全不會有異常，系統的設計已經充分考慮了這種情況，非常健壯。**

* **DB 記錄是否異常？**
    * [cite_start]**不會**。資料庫 (`db_schema.py` 定義的結構) [cite: 3] [cite_start]記錄的都是歷史事實，例如 `orders` 表記錄的是**曾經下過的單**，`trade_logs` 記錄的是**已經發生的成交**。這些記錄有唯一的 ID 和時間戳，出入金或重啟不會影響歷史數據的準確性。`BalanceSnapshot` 也只會忠實地在下一個時間點記錄您新的餘額快照 [cite: 3]。

* **原掛單是否會有異常？**
    * **不會，且會被安全地處理掉。**
    * [cite_start]這正是 `handle_orphan_orders_on_startup` 函數的核心價值 [cite: 4][cite_start]。無論您上次關閉程式時市場上有多少掛單，只要您一重啟，這個函數會被**最優先執行**，它的唯一任務就是呼叫 `cancel_all_v2_market_orders`，將您在 MAX 交易所上屬於這個交易對的所有掛單**全部撤銷** [cite: 4, 2]。
    * 這樣做可以完美地避免任何「孤兒訂單」（即程式關閉後，無人管理的舊訂單）在未知的價格被成交，從而確保了資金安全和策略的一致性。撤銷完舊訂單後，程式才會用最新的資金和市場狀況去建立全新的網格。

希望這份詳細的說明能幫助您完全理解並信賴您所擁有的這套強大的自動化交易系統。