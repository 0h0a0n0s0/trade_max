# 策略優化歷程完整記錄

**最後更新**: 2025-12-13  
**目標ROI**: 15-20% 年化  
**數據範圍**: 2025年全年（496,699根1分鐘K線）

---

## 📋 目錄

1. [第一次診斷分析（2025-12-12）](#第一次診斷分析)
2. [第一次優化（初始狀態）](#第一次優化)
3. [第二次優化（ATR動態網格 + ADX過濾器）](#第二次優化)
4. [第三次優化（放寬條件 + 提高標準）](#第三次優化)
5. [第四次優化（完全轉向趨勢跟隨）](#第四次優化)
6. [第五次優化（多指標複合判斷）](#第五次優化)

---

## 第一次診斷分析

**時間**: 2025-12-12  
**目的**: 分析策略在2025年市場環境下的表現

### 📊 診斷結果

#### 策略表現
- **盈利樣本比例**: 0% (10個樣本全部虧損)
- **平均 ROI**: -2.13%
- **ROI 範圍**: -2.76% ~ -0.86%
- **平均最大回撤**: 10.08%
- **平均交易次數**: 118次
- **平均每筆交易利潤**: -122.04 TWD

#### 市場環境分析
- **平均 ADX**: 42.98（強趨勢市場）
- **強趨勢時段**: 77.8%
- **弱趨勢時段**: 11.9%
- **網格適合度評分**: 26.6/100（不適合）
- **平均 ATR**: 0.002 TWD (0.01%)
- **平均日內波動**: 0.01%

#### 關鍵問題識別
1. **市場環境不適合網格交易** ⚠️
   - 市場77.8%時間都是強趨勢
   - 網格交易適合震盪市場，不適合強趨勢市場

2. **網格成交率極低** ⚠️
   - 平均網格成交率: 0.51%
   - 平均網格成交次數: 113次
   - 平均掛單數: 22,000+次

3. **波動率過低** ⚠️
   - 市場波動率極低，需要設置非常小的網格間距

### 💡 改進建議

1. **啟用混合模式並優化**
   - 在強趨勢市場（ADX > 30）時，完全關閉網格，只使用趨勢跟隨
   - 在弱趨勢市場（ADX < 20）時，使用網格策略

2. **基於ATR動態調整網格間距**
   - `small_gap = ATR * 0.5 ~ 1.0`

3. **大幅縮小網格間距範圍**
   - 從 0.01 - 0.10 TWD 調整至 0.001 - 0.01 TWD

---

## 第一次優化

**時間**: 2025-12-12  
**迭代次數**: 6000  
**篩選條件**: ROI > 5% AND MaxDD < 15%

### 📊 參數設置（初始狀態）

| 參數 | 範圍/值 | 說明 |
|------|---------|------|
| `small_gap` | 0.01 - 0.10 TWD | 網格基礎間距 |
| `mid_mult` | 2 - 6 | 中層網格倍數 |
| `big_mult` | 5 - 15 | 大層網格倍數 |
| `size_pct_small` | 0.01 - 0.05 | 小層訂單大小 |
| `size_pct_mid` | 0.015 - 0.06 | 中層訂單大小 |
| `size_pct_big` | 0.02 - 0.08 | 大層訂單大小 |
| `ema_span_fast_bars` | 30 - 1200 | EMA快線週期 |
| `ema_span_slow_bars` | 600 - 8000 | EMA慢線週期 |
| `use_atr_spacing` | false | 未啟用ATR動態網格 |
| `use_adx_filter` | false | 未啟用ADX過濾器 |
| `use_hybrid_model` | true | 啟用混合模式 |
| `trend_trade_equity_pct` | 0.4 | 趨勢跟隨倉位40% |
| `adx_strength_threshold` | 15 | ADX趨勢強度門檻 |

### 📈 優化結果

- **有效參數**: 0個 ❌
- **最佳ROI**: 無
- **關鍵發現**: 篩選條件過於嚴格，參數範圍可能不合適

### 🔍 問題分析

1. 篩選條件過於嚴格（ROI > 5%）
2. 未啟用ATR動態網格，網格間距可能不適合低波動市場
3. 未啟用ADX過濾器，在強趨勢市場中網格交易表現差

---

## 第二次優化

**時間**: 2025-12-12  
**迭代次數**: 5000  
**篩選條件**: ROI > 0% AND MaxDD < 20%  
**策略改進**: 啟用ATR動態網格、ADX過濾器（漸進式縮減）

### 📊 參數調整

| 參數 | 調整前 | 調整後 | 說明 |
|------|--------|--------|------|
| `use_atr_spacing` | false | **true** | ✅ 啟用ATR動態網格 |
| `atr_period` | - | 14 | ATR計算週期 |
| `atr_spacing_multiplier` | - | 0.3 - 1.5 | ATR乘數範圍 |
| `use_adx_filter` | false | **true** | ✅ 啟用ADX過濾器 |
| `adx_threshold` | - | 30 | ADX過濾器門檻 |
| `small_gap` | 0.01 - 0.10 | 0.01 - 0.10 | 保持不變 |
| `levels_each` | 12 | 12 | 保持不變 |
| 篩選條件 | ROI > 5% | **ROI > 0%** | ✅ 放寬篩選條件 |

### 🔧 策略邏輯調整

1. **ATR動態網格間距**
   - 根據市場波動率自動調整網格間距
   - `effective_gap = ATR * atr_spacing_multiplier`

2. **ADX過濾器（漸進式縮減）**
   - ADX > 55: 減少60%網格規模
   - ADX 45-55: 減少40%網格規模
   - ADX 30-45: 減少20%網格規模
   - ADX <= 30: 正常網格規模

### 📈 優化結果

- **有效參數**: **8個** ✅
- **最佳表現**:
  - ROI: **0.40%**
  - MaxDD: 1.39%
  - 交易次數: 9次
  - 總損益: 2,527 TWD

### 📊 有效參數特徵分析

| 參數 | 範圍 | 說明 |
|------|------|------|
| `atr_spacing_multiplier` | 0.864 - 1.251 | 集中在0.9-1.2，較高 |
| `size_pct_small` | 0.029 - 0.068 | 中等偏小 |
| `ema_span_fast_bars` | 620 - 760 | 較短，適應強趨勢 |
| `ema_span_slow_bars` | 534 - 727 | 較短，快慢線差距小 |
| `bias_high` | 0.57 - 0.64 | 中等偏高 |

### 🔍 關鍵發現

1. ✅ **找到了能盈利的參數**，但ROI極低（0.4%）
2. ⚠️ **交易次數極少**（8-9次/年），說明策略過於保守
3. ⚠️ **ROI天花板效應**：0.4%可能是當前策略的上限

---

## 第三次優化

**時間**: 2025-12-12  
**迭代次數**: 10000  
**篩選條件**: ROI > 1% AND MaxDD < 15%  
**策略改進**: 進一步放寬ADX過濾器、提高訂單大小、增加網格層級

### 📊 參數調整

| 參數 | 調整前 | 調整後 | 說明 |
|------|--------|--------|------|
| `atr_spacing_multiplier` | 0.3 - 1.5 | 0.2 - 2.0 | ✅ 擴大範圍 |
| `mid_mult` | 2 - 6 | 2 - 5 | 略微收窄 |
| `big_mult` | 5 - 15 | 5 - 12 | 略微收窄 |
| `size_pct_small` | 0.01 - 0.05 | **0.03 - 0.08** | ✅ 提高訂單大小 |
| `size_pct_mid` | 0.015 - 0.06 | **0.04 - 0.10** | ✅ 提高訂單大小 |
| `size_pct_big` | 0.02 - 0.08 | **0.05 - 0.12** | ✅ 提高訂單大小 |
| `ema_span_fast_bars` | 30 - 1200 | 30 - 800 | 略微收窄 |
| `ema_span_slow_bars` | 600 - 8000 | 500 - 5000 | 略微收窄 |
| `levels_each` | 12 | **16 - 24** | ✅ 增加網格層級 |
| 篩選條件 | ROI > 0% | **ROI > 1%** | ⚠️ 提高篩選標準 |

### 🔧 策略邏輯調整

1. **ADX過濾器進一步放寬**
   - ADX > 50: 減少60%網格規模（原減少90%）
   - ADX 40-50: 減少40%網格規模（原減少75%）
   - ADX 30-40: 減少20%網格規模（原減少50%）
   - ADX <= 30: 正常網格規模

### 📈 優化結果

- **有效參數**: **0個** ❌
- **最佳ROI**: 無
- **關鍵發現**: **提高篩選條件後完全找不到參數，說明0.4% ROI已接近上限**

### 🔍 問題分析

1. **ROI天花板效應確認**
   - ROI > 0%時能找到0.4%的參數
   - ROI > 1%時完全找不到參數
   - **結論**: 0.4% ROI是當前策略在2025年市場環境下的上限

2. **策略與市場環境不匹配**
   - 市場77.8%時間都是強趨勢
   - 網格交易在強趨勢市場表現差
   - 需要更依賴趨勢跟隨，而非網格

---

## 第四次優化

**時間**: 2025-12-13  
**迭代次數**: 10000  
**篩選條件**: ROI > 2% AND MaxDD < 15%  
**策略改進**: 完全轉向趨勢跟隨策略

### 📊 參數調整

| 參數 | 調整前 | 調整後 | 說明 |
|------|--------|--------|------|
| `use_adx_filter` | true | **false** | ✅ 完全禁用ADX過濾器 |
| `trend_trade_equity_pct` | 0.4 | **0.7** | ✅ 提高趨勢跟隨倉位至70% |
| `adx_strength_threshold` | 15 | **10** | ✅ 降低趨勢進場門檻 |
| `atr_spacing_multiplier` | 0.2 - 2.0 | 0.5 - 1.5 | 略微收窄（網格作為輔助） |
| `ema_span_fast_bars` | 30 - 800 | **100 - 600** | ✅ 聚焦較短週期 |
| `ema_span_slow_bars` | 500 - 5000 | **300 - 2000** | ✅ 聚焦較短週期 |
| `levels_each` | 16 - 24 | 12 - 20 | 適中（網格作為輔助） |
| 篩選條件 | ROI > 1% | **ROI > 2%** | ⚠️ 提高篩選標準 |

### 🔧 策略邏輯調整

1. **完全禁用ADX過濾器**
   - 不再根據ADX限制網格規模
   - 讓策略主要依靠趨勢跟隨

2. **降低趨勢進場門檻**
   - 從ADX > 15降低至ADX > 10（動態調整至7-10）
   - 更容易觸發趨勢跟隨模式

3. **提高趨勢跟隨倉位**
   - 從40%提升至70%
   - 更積極地使用趨勢跟隨

4. **優化EMA參數範圍**
   - 使用較短的EMA週期（100-600分鐘）
   - 適應強趨勢市場，快速捕捉趨勢

### 📈 優化結果

- **有效參數**: **0個** ❌
- **最佳ROI**: 無
- **耗時**: 222.4分鐘（3.71小時）

### 📊 診斷回測結果（5個樣本）

- **平均ROI**: **-10.68%**（大幅虧損）❌
- **平均MaxDD**: 17.49%
- **交易次數**: 220次
- **趨勢進場次數**: 3-4次（實際）
- **趨勢出場次數**: 3次
- **網格成交率**: 0.86%（極低）

### 🔍 問題分析

1. **趨勢進場條件過於簡單**
   - 當前條件：EMA方向 + ADX > 10
   - 問題：容易誤判，沒有考慮價格動量、超買超賣狀態

2. **複合條件判斷過於嚴格**
   - 需要同時滿足EMA方向和ADX強度
   - 可能錯過早期趨勢信號

3. **缺少輔助指標**
   - 沒有RSI（判斷超買超賣）
   - 沒有MACD（判斷動量）
   - 無法過濾假信號

---

## 第五次優化（當前）

**時間**: 2025-12-13  
**迭代次數**: 待運行  
**篩選條件**: ROI > 1% AND MaxDD < 15%  
**策略改進**: 多指標複合判斷（OR邏輯，放寬條件）

### 📊 參數調整

| 參數 | 調整前 | 調整後 | 說明 |
|------|--------|--------|------|
| `use_multi_indicator` | false | **true** | ✅ 啟用多指標複合判斷 |
| `rsi_period` | - | **14** | ✅ 新增RSI週期 |
| `rsi_bull_threshold` | - | **45.0 - 55.0** | ✅ 多頭RSI門檻 |
| `rsi_bear_threshold` | - | **45.0 - 55.0** | ✅ 空頭RSI門檻 |
| `adx_min_threshold` | - | **6 - 12** | ✅ 最低ADX門檻（激進條件） |
| `adx_strength_threshold` | 10 | 8 - 15 | 保持可優化 |
| 篩選條件 | ROI > 2% | **ROI > 1%** | ✅ 放寬篩選條件 |

### 🔧 策略邏輯調整

#### 1. 多指標複合進場條件（OR邏輯，放寬條件）

**多頭進場條件（任一條件滿足即可）**：
- **條件A（主要）**: EMA快線 > 慢線 AND ADX > 門檻 AND RSI > 50（動量確認）
- **條件B（輔助）**: EMA快線 > 慢線 AND MACD > 0 AND RSI > 45（放寬RSI）
- **條件C（激進）**: EMA快線 > 慢線 AND ADX > 8（降低ADX門檻）

**空頭進場條件（任一條件滿足即可）**：
- **條件A（主要）**: EMA快線 < 慢線 AND ADX > 門檻 AND RSI < 50（動量確認）
- **條件B（輔助）**: EMA快線 < 慢線 AND MACD < 0 AND RSI < 55（放寬RSI）
- **條件C（激進）**: EMA快線 < 慢線 AND ADX > 8（降低ADX門檻）

#### 2. 優化出場條件

**多指標出場條件（OR邏輯）**：
- **條件1**: Trailing Stop（原有邏輯）
- **條件2**: 趨勢反轉（EMA快線與慢線交叉反向）
- **條件3**: ADX弱化（ADX < 最低門檻，趨勢結束）

### 📈 優化結果

- **有效參數**: **0個** ❌
- **最佳ROI**: 無
- **耗時**: 633.5分鐘（10.56小時）
- **關鍵發現**: 即使使用多指標複合判斷（EMA + ADX + RSI + MACD），仍無法找到ROI > 1%的參數

### 🔍 問題分析

1. **多指標複合判斷仍不足**
   - 即使使用OR邏輯放寬條件，仍無法找到有效參數
   - 說明當前指標組合可能不適合2025年市場環境

2. **參數範圍可能仍需調整**
   - EMA、RSI等參數範圍可能偏離業界標準
   - 需要參考業界最佳實踐調整參數範圍

3. **可能需要更多指標**
   - 當前使用：EMA、ADX、RSI、MACD
   - 未使用：布林帶、隨機震盪指標、OBV
   - 可以考慮加入更多指標進行複合判斷

---

## 📊 優化歷程總結對比表

| 優化輪次 | 時間 | 迭代次數 | 篩選條件 | 關鍵策略改進 | 有效參數 | 最佳ROI | 交易次數 | 關鍵發現 |
|---------|------|---------|---------|------------|---------|---------|---------|---------|
| **第一次** | 2025-12-12 | 6000 | ROI > 5%<br>MaxDD < 15% | 初始狀態 | 0個 | - | - | 條件過嚴 |
| **第二次** | 2025-12-12 | 5000 | ROI > 0%<br>MaxDD < 20% | ATR動態網格<br>ADX過濾器 | **8個** ✅ | **0.40%** | 8-9次 | 找到能盈利的參數，但ROI極低 |
| **第三次** | 2025-12-12 | 10000 | ROI > 1%<br>MaxDD < 15% | 放寬ADX過濾器<br>提高訂單大小 | **0個** ❌ | - | - | **0.4% ROI已接近上限** |
| **第四次** | 2025-12-13 | 10000 | ROI > 2%<br>MaxDD < 15% | 完全轉向趨勢跟隨<br>禁用ADX過濾器 | **0個** ❌ | - | 220次 | 趨勢進場條件過於簡單，ROI -10.68% |
| **第五次** | 2025-12-13 | 20000 | ROI > 1%<br>MaxDD < 15% | 多指標複合判斷<br>OR邏輯放寬條件 | **0個** ❌ | - | - | 即使多指標複合判斷仍無法找到有效參數 |
| **第六次** | 2025-12-13 | 待運行 | ROI > 0.5%<br>MaxDD < 15% | 加入布林帶+隨機指標<br>參考業界標準參數 | 待運行 | 待運行 | 待運行 | 擴展指標+業界最佳實踐 |

---

## 🔍 關鍵發現總結

### 1. ROI天花板效應（最關鍵）

- **發現**: 
  - 篩選條件 ROI > 0%：能找到 0.36-0.40% 的參數
  - 篩選條件 ROI > 1%：完全找不到參數
- **結論**: **0.4% ROI是當前策略在2025年市場環境下的上限**
- **影響**: 無法通過參數優化達到15-20%目標

### 2. 市場環境不適合網格交易

- **市場特徵**: 
  - 平均 ADX: 42.98（強趨勢）
  - 強趨勢時段: 77.8%
  - 弱趨勢時段: 11.9%
- **策略特徵**: 網格交易適合震盪市場
- **結果**: 策略在大部分時間無法有效運作

### 3. 交易頻率極低

- **發現**: 所有有效參數都只有 **8-9次交易/年**
- **原因**: 
  - ADX過濾器限制了77.8%的市場時間
  - 趨勢跟隨觸發條件嚴格
  - 市場環境不適合網格交易

### 4. 趨勢跟隨未充分利用

- **發現**: 趨勢進場只有3-4次，出場2-3次
- **問題**: 在強趨勢市場中，趨勢跟隨應該更積極
- **改進**: 降低進場門檻、提高倉位比例、加入多指標確認

---

## 💡 改進方向總結

### 方向1：完全轉向趨勢跟隨策略 ⭐⭐⭐⭐⭐（已實施）

**實施內容**：
1. ✅ 禁用ADX過濾器
2. ✅ 降低趨勢進場門檻（ADX > 10）
3. ✅ 提高趨勢跟隨倉位（70%）
4. ✅ 優化EMA參數（較短週期）

**結果**: 仍未找到有效參數，ROI -10.68%

### 方向2：多指標複合判斷 ⭐⭐⭐⭐⭐（當前實施）

**實施內容**：
1. ✅ 加入RSI和MACD計算
2. ✅ 實現多條件OR邏輯進場
3. ✅ 優化出場條件（趨勢反轉、ADX弱化）
4. ✅ 放寬篩選條件（ROI > 1%）

**預期**: 進場次數提升至20-50次，ROI改善至0-5%

---

## 📋 下一步計劃

### 立即行動

1. **運行第五次優化**
   - 使用多指標複合判斷
   - 觀察進場次數和ROI改善

2. **如果找到ROI > 1%的參數**
   - 繼續優化至ROI > 5%
   - 分析有效參數特徵

3. **如果仍無法找到有效參數**
   - 考慮調整策略目標
   - 或等待更適合的市場環境

---

## ⚠️ 重要結論

1. **當前策略在2025年市場環境下，ROI上限約為0.4%**
2. **要達到15-20% ROI，需要根本性的策略調整**
3. **多指標複合判斷是最新的改進方向，預期能改善表現**
4. **如果無法達到5% ROI，需要重新評估策略目標**

---

## 第六次優化（當前計劃）

**時間**: 2025-12-13  
**迭代次數**: 待運行  
**篩選條件**: ROI > 0.5% AND MaxDD < 15%  
**策略改進**: 加入布林帶和隨機震盪指標，參考業界最佳實踐參數

### 📊 可用指標分析

#### 當前已使用的指標
1. ✅ **EMA**（指數移動平均線）- 趨勢方向判斷
2. ✅ **ADX**（平均方向指數）- 趨勢強度判斷
3. ✅ **RSI**（相對強弱指數）- 超買超賣判斷
4. ✅ **MACD**（移動平均收斂發散）- 動量判斷
5. ✅ **ATR**（平均真實波幅）- 波動率判斷

#### 未使用的指標（可加入）
1. ⚠️ **Bollinger Bands（布林帶）** - 價格位置判斷
2. ⚠️ **Stochastic Oscillator（隨機震盪指標）** - 超買超賣判斷
3. ⚠️ **OBV（能量潮指標）** - 成交量確認（需要成交量數據）

### 💡 業界最佳實踐參考

根據量化交易社群經驗：

| 參數類型 | 業界標準範圍 | 當前範圍 | 建議調整 |
|---------|------------|---------|---------|
| **EMA快線** | 12 - 50 | 100 - 600 | ✅ 調整至12-50 |
| **EMA慢線** | 26 - 200 | 300 - 2000 | ✅ 調整至26-200 |
| **RSI週期** | 14 - 21 | 10 - 20 | ✅ 調整至14-21 |
| **RSI超買** | 70 - 80 | 45 - 55 | ✅ 調整至50-60 |
| **RSI超賣** | 20 - 30 | 45 - 55 | ✅ 調整至40-50 |
| **ADX門檻** | 20 - 25 | 8 - 15 | ⚠️ 保持較低（適應強趨勢市場） |

### 🔧 策略改進計劃

#### 1. 加入新指標
- **布林帶**: 判斷價格相對位置，過濾極端市場
- **隨機震盪指標**: 提供另一個超買超賣判斷維度

#### 2. 擴展複合進場條件

**多頭進場條件（OR邏輯，進一步放寬）**：
- **條件A（主要）**: EMA快線 > 慢線 AND ADX > 10 AND RSI > 50 AND MACD > 0
- **條件B（輔助）**: EMA快線 > 慢線 AND MACD > 0 AND RSI > 45 AND 價格接近布林帶下軌
- **條件C（激進）**: EMA快線 > 慢線 AND ADX > 8 AND 隨機指標%K < 30（超賣反彈）
- **條件D（極度放寬）**: EMA快線 > 慢線 AND ADX > 6（最低門檻）

#### 3. 參數範圍調整

| 參數 | 調整前 | 調整後 | 說明 |
|------|--------|--------|------|
| `ema_span_fast_bars` | 100 - 600 | **12 - 50** | ✅ 使用業界標準短期EMA |
| `ema_span_slow_bars` | 300 - 2000 | **26 - 200** | ✅ 使用業界標準長期EMA |
| `rsi_period` | 10 - 20 | **14 - 21** | ✅ 使用業界標準RSI週期 |
| `rsi_bull_threshold` | 45 - 55 | **50 - 60** | ✅ 放寬多頭RSI門檻 |
| `rsi_bear_threshold` | 45 - 55 | **40 - 50** | ✅ 放寬空頭RSI門檻 |
| `adx_strength_threshold` | 8 - 15 | **6 - 12** | ✅ 進一步降低ADX門檻 |
| `adx_min_threshold` | 6 - 12 | **5 - 10** | ✅ 降低最低ADX門檻 |
| 篩選條件 | ROI > 1% | **ROI > 0.5%** | ✅ 放寬篩選條件 |

### 📈 預期改進

1. **進場次數**: 從3-4次提升至50-100次（進一步放寬條件）
2. **ROI**: 從-10.68%改善至0-3%（多指標確認減少虧損）
3. **有效參數**: 預期能找到ROI > 0.5%的參數

### 📋 詳細方案

詳見：`第六次優化方案.md`

---

**最後更新**: 2025-12-13  
**下次更新**: 第六次優化結果出爐後

